---

- name: Increment TRM for EVPN overlay
  hosts: all
  gather_facts: no

  tasks:
            - name: Load variables
              run_once: true
              block:
              - name: Set playbook mode
                set_fact:
                  playbook_mode: '-inc'

              - name: Load vars from trm_create_vars.yml
                include_vars: 
                  file: "./group_vars/trm_create_vars.yml"
                  name: trm_create_vars

              - name: Load vars from trm_overlay_db.yml
                include_vars: 
                  file: "./group_vars/trm_overlay_db.yml"
                  name: trm_db_vars

              - name: Filter interested DAGs when vrfs is not 'all'
                set_fact:
                  vrfs: "{{ (vrfs | default({})) | combine ({item.key: item.value}) }}"
                with_dict: "{{ trm_db_vars.vrfs }}"
                when: "item.key in trm_create_vars.vrfs or 'all' in trm_create_vars.vrfs"

- name: Display output info
  hosts: localhost
  gather_facts: no

  tasks:
            - set_fact:
                playbook_mode: '-inc'

- name: Import tasks from playbook_trm_overlay_preview.yml
  import_playbook: playbook_trm_overlay_preview.yml
